<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>실시간 음정 퍼펙트 스코어</title>
<style>
body{margin:0;background:#0b0b0b;color:#fff;font-family:"Noto Sans KR",sans-serif;display:flex;flex-direction:column;align-items:center;min-height:100vh;padding:12px}
h2{text-align:center;margin-bottom:12px}
.container{display:flex;width:95%;max-width:1000px;gap:12px}
.left-panel{flex:0 0 180px;background:rgba(255,255,255,0.05);border-radius:12px;padding:16px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}
.left-panel div{margin:6px 0;}
.note{font-size:52px;font-weight:bold;color:#FFDD33;}
.korNote{font-size:22px;color:#ccc;}
.octave{font-size:20px;color:#88CCFF;}
.freq{font-size:18px;color:#bbb;}
.right-panel{flex:1;background:rgba(255,255,255,0.05);border-radius:12px;padding:12px;position:relative}
canvas{width:100%;height:400px;border-radius:8px;display:block;background:#111}
.controls{margin-top:12px;text-align:center}
button{background:#222;color:#fff;border:1px solid #444;padding:8px 14px;margin:0 6px;border-radius:6px;cursor:pointer}
button:disabled{opacity:.5;cursor:not-allowed}
.status{margin-top:10px;text-align:center;color:#ccc;font-size:14px}
</style>
</head>
<body>
<h2>🎤 실시간 음정 퍼펙트 스코어</h2>
<div class="container">
  <div class="left-panel">
    <div id="noteDisplay" class="note">-</div>
    <div id="korNoteDisplay" class="korNote">-</div>
    <div id="octaveDisplay" class="octave">- 옥타브</div>
    <div id="freqDisplay" class="freq">- Hz</div>
  </div>
  <div class="right-panel">
    <canvas id="board" width="800" height="400"></canvas>
  </div>
</div>
<div class="controls">
  <button id="startBtn">측정 시작</button>
  <button id="stopBtn" disabled>중지</button>
  <button id="resetBtn" disabled>리셋</button>
</div>
<div class="status" id="rangeStatus">기록 음역대: -</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
const NOTE_COLORS={'C':'#FF3B30','C#':'#FF7F50','D':'#FF9F33','D#':'#FFB84D','E':'#FFD700','F':'#8BE24B','F#':'#34D399','G':'#3B82F6','G#':'#6366F1','A':'#8B5CF6','A#':'#C084FC','B':'#F472B6'};
const NOTE_NAMES=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const NOTE_KOR={'C':'도','C#':'도#','D':'레','D#':'레#','E':'미','F':'파','F#':'파#','G':'솔','G#':'솔#','A':'라','A#':'라#','B':'시'};

const WINDOW_SEC=8,MIN_RMS=0.02,MIN_FREQ=60,MAX_FREQ=1500;
const HOLD_DURATION=0.3,SMOOTH_ALPHA=0.08,STABLE_THRESHOLD=0.05;

let audioCtx,analyser,source,dataArray,rafId,startTime,smoothing={lastFreq:0,alpha:SMOOTH_ALPHA};
let bars=[],activeIndex=null,candidate=null,lastDetectedAt=0;
let minMidi=null,maxMidi=null;
let stableNote=null, stableSince=0;

const canvas=document.getElementById('board'),ctx=canvas.getContext('2d'),dpr=window.devicePixelRatio||1;
canvas.width=canvas.clientWidth*dpr;canvas.height=canvas.clientHeight*dpr;

const noteDisplay=document.getElementById('noteDisplay');
const korNoteDisplay=document.getElementById('korNoteDisplay');
const octaveDisplay=document.getElementById('octaveDisplay');
const freqDisplay=document.getElementById('freqDisplay');
const rangeStatus=document.getElementById('rangeStatus');

const startBtn=document.getElementById('startBtn'),
      stopBtn=document.getElementById('stopBtn'),
      resetBtn=document.getElementById('resetBtn');

startBtn.onclick=startAudio; stopBtn.onclick=stop; resetBtn.onclick=resetAll;

function autoCorrelate(buf,sr){
  const SIZE=buf.length;let rms=0;
  for(let i=0;i<SIZE;i++) rms+=buf[i]*buf[i];
  rms=Math.sqrt(rms/SIZE);if(rms<MIN_RMS)return-1;
  const c=new Float32Array(SIZE);
  for(let lag=0;lag<SIZE;lag++){let s=0;for(let i=0;i<SIZE-lag;i++)s+=buf[i]*buf[i+lag];c[lag]=s;}
  let d=0;while(d<SIZE-1&&c[d]>c[d+1])d++;
  let maxval=-1,maxpos=-1;for(let i=d;i<SIZE;i++){if(c[i]>maxval){maxval=c[i];maxpos=i;}}
  if(maxpos<=0)return-1;
  const T0=maxpos,x1=c[T0-1]||0,x2=c[T0]||0,x3=c[T0+1]||0;
  const a=(x1+x3-2*x2)/2,b=(x3-x1)/2;const T0i=a?T0-b/(2*a):T0;
  const freq=sr/T0i;if(freq<MIN_FREQ||freq>MAX_FREQ)return-1;
  return freq;
}
function freqToMIDI(f){return 69+12*Math.log2(f/440);}
function midiToNote(midiFloat){
  const midi=Math.round(midiFloat);
  const name=NOTE_NAMES[(midi%12+12)%12];
  const octave=Math.floor(midi/12)-1-2;
  return {midi,name,octave};
}

async function startAudio(){
  if(audioCtx)return;
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  await audioCtx.resume();
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    source=audioCtx.createMediaStreamSource(stream);
    analyser=audioCtx.createAnalyser();analyser.fftSize=2048;
    source.connect(analyser);
    dataArray=new Float32Array(analyser.fftSize);
    startTime=audioCtx.currentTime;bars=[];activeIndex=null;candidate=null;minMidi=maxMidi=null;
    rafId=requestAnimationFrame(loop);
    startBtn.disabled=true; stopBtn.disabled=false; resetBtn.disabled=true;
  }catch(e){alert("마이크 접근 권한을 허용해주세요.");console.error(e);}
}

function stop(){
  if(!audioCtx)return;
  cancelAnimationFrame(rafId);
  try{analyser.disconnect();source.disconnect();}catch(e){}
  audioCtx.close();audioCtx=null;
  stopBtn.disabled=true; startBtn.disabled=false; resetBtn.disabled=false;
}

function resetAll(){
  bars=[];activeIndex=null;candidate=null;minMidi=maxMidi=null;
  smoothing.lastFreq=0;draw(0);
  noteDisplay.textContent="-"; korNoteDisplay.textContent="-";
  octaveDisplay.textContent="- 옥타브"; freqDisplay.textContent="- Hz";
  rangeStatus.textContent="기록 음역대: -";
  resetBtn.disabled=true;
}

function loop(){
  analyser.getFloatTimeDomainData(dataArray);
  const now=audioCtx.currentTime,relNow=now-startTime;
  let f=autoCorrelate(dataArray,audioCtx.sampleRate);
  if(f>0) f=smoothing.lastFreq*(1-smoothing.alpha)+f*smoothing.alpha,smoothing.lastFreq=f,lastDetectedAt=now;
  else f=-1;
  if(f>0){
    const midiFloat=freqToMIDI(f),note=midiToNote(midiFloat);
    if(minMidi===null||midiFloat<minMidi)minMidi=midiFloat;
    if(maxMidi===null||midiFloat>maxMidi)maxMidi=midiFloat;
    if(!candidate||candidate.midi!==note.midi) candidate={midi:note.midi,first:now};
    else if(now-candidate.first>STABLE_THRESHOLD){
      if(activeIndex!==null&&bars[activeIndex].midi===note.midi) bars[activeIndex].end=relNow;
      else bars.push({midi:note.midi,name:note.name,octave:note.octave,start:relNow,end:relNow,color:NOTE_COLORS[note.name]||"#fff"}),activeIndex=bars.length-1;
    }
    if(activeIndex!==null) bars[activeIndex].end=relNow;

    // 왼쪽 패널 업데이트 (안정화된 음만)
    if(stableNote!==note.midi){
      if(stableSince===0) stableSince=now;
      if(now-stableSince>0.25){ // 0.25초 이상 같은 음 유지
        stableNote=note.midi;
        updateStatus(note,f);
      }
    } else {
      stableSince=0;
      updateStatus(note,f);
    }
  }else{if(activeIndex!==null&&(now-lastDetectedAt)>HOLD_DURATION){activeIndex=null;candidate=null;}}
  draw(relNow);
  rafId=requestAnimationFrame(loop);
}

function updateStatus(note,freq){
  noteDisplay.textContent=note.name;
  korNoteDisplay.textContent=NOTE_KOR[note.name]||note.name;
  octaveDisplay.textContent=note.octave+" 옥타브";
  freqDisplay.textContent=freq.toFixed(1)+" Hz";
  if(minMidi&&maxMidi){
    const minN=midiToNote(minMidi),maxN=midiToNote(maxMidi);
    rangeStatus.textContent=`기록 음역대: ${minN.name}${minN.octave} ~ ${maxN.name}${maxN.octave}`;
  }
}

function draw(relNow){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const W=canvas.width,H=canvas.height,padL=50*dpr,padR=20*dpr,padT=20*dpr,padB=30*dpr;
  const innerW=W-padL-padR,innerH=H-padT-padB;
  const minMidiView=36,maxMidiView=84,midiRange=maxMidiView-minMidiView;
  function midiToY(m){return padT+innerH*(1-(m-minMidiView)/midiRange);}
  const pxPerSec=innerW/WINDOW_SEC,windowStart=relNow-WINDOW_SEC;

  // 배경 점선 (자연음만)
  ctx.setLineDash([4*dpr,4*dpr]);
  ctx.strokeStyle="rgba(255,255,255,0.2)";ctx.lineWidth=1*dpr;
  for(let m=minMidiView;m<=maxMidiView;m++){
    const noteName=NOTE_NAMES[m%12];
    if(["C","D","E","F","G","A","B"].includes(noteName)){
      const y=midiToY(m);
      ctx.beginPath();ctx.moveTo(padL,y);ctx.lineTo(W-padR,y);ctx.stroke();

      // 🎵 여기서 라벨을 "C4", "D#4" 형식으로 표시
      const octave = Math.floor(m/12) - 1 - 2; // 보컬식 옥타브
      ctx.fillStyle="#aaa";
      ctx.font=`${12*dpr}px sans-serif`;
      ctx.fillText(noteName + octave, 5, y+4*dpr);
    }
  }
  ctx.setLineDash([]);

  // 음정 막대
  for(const b of bars){
    const sx=padL+(b.start-windowStart)*pxPerSec,ex=padL+(b.end-windowStart)*pxPerSec;
    if(ex<padL||sx>W-padR) continue;
    const y=midiToY(b.midi)-8*dpr,w=Math.max(2,ex-sx),h=16*dpr;
    ctx.fillStyle=b.color;
    roundRect(ctx,sx,y,w,h,6*dpr);ctx.fill();
    ctx.strokeStyle="#fff";ctx.lineWidth=2*dpr;ctx.stroke();
  }
}
function roundRect(ctx,x,y,w,h,r){
  if(w<2*r) r=w/2;if(h<2*r) r=h/2;
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}
});
</script>
</body>
</html>
